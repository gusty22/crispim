<!doctype html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Cadastro de Usuários</title>

    <style>
        /* 1. Importação da Fonte e Variáveis de Cor */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');

        :root {
            --cor-fundo: #f8f9fa;            /* Cinza muito claro */
            --cor-superficie: #ffffff;       /* Branco (para os cards) */
            --cor-primaria: #4C6EF5;         /* Azul moderno */
            --cor-primaria-hover: #405ED6;   /* Azul mais escuro (hover) */
            --cor-texto-primario: #212529;   /* Preto suave */
            --cor-texto-secundario: #6c757d; /* Cinza médio */
            --cor-borda: #e9ecef;            /* Cinza claro para bordas */
            --cor-perigo: #e03131;           /* Vermelho suave */
            --cor-info: #17a2b8;             /* Azul-petróleo (Editar) */
            --sombra-card: 0 4px 12px rgba(0, 0, 0, 0.05);
        }

        /* 2. Reset e Estilos Globais */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background-color: var(--cor-fundo);
            color: var(--cor-texto-primario);
            line-height: 1.6;
        }

        /* 3. Navegação */
        .navbar {
            background-color: var(--cor-superficie);
            padding: 1rem 2.5rem;
            border-bottom: 1px solid var(--cor-borda);
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: var(--sombra-card);
        }
        .navbar .logo {
            font-weight: 700;
            font-size: 1.5rem;
            color: var(--cor-primaria);
            text-decoration: none;
        }
        .navbar .nav-links a {
            color: var(--cor-texto-secundario);
            text-decoration: none;
            margin-left: 2rem;
            font-weight: 500;
            transition: color 0.2s ease-in-out;
        }
        .navbar .nav-links a:hover {
            color: var(--cor-texto-primario);
        }
        .navbar .nav-links a.active {
            color: var(--cor-primaria);
            font-weight: 600;
        }

        /* 4. Layout Principal e Cards */
        .container {
            max-width: 1300px;
            margin: 2.5rem auto;
            padding: 0 2rem;
        }
        .main-grid {
            display: grid;
            grid-template-columns: 1fr 2fr;
            gap: 2rem;
            align-items: flex-start;
        }
        .card {
            background-color: var(--cor-superficie);
            border: 1px solid var(--cor-borda);
            border-radius: 12px;
            padding: 2.5rem;
            box-shadow: var(--sombra-card);
        }
        .card-title {
            font-size: 1.5rem;
            margin-bottom: 1.5rem;
            font-weight: 600;
            color: var(--cor-texto-primario);
            border-bottom: 1px solid var(--cor-borda);
            padding-bottom: 1rem;
        }

        /* 5. Formulários */
        label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
            color: var(--cor-texto-secundario);
            font-size: 0.9rem;
        }
        input, select {
            width: 100%;
            padding: 0.75rem 1rem;
            margin-bottom: 1.5rem;
            background-color: var(--cor-fundo);
            border: 1px solid var(--cor-borda);
            border-radius: 8px;
            color: var(--cor-texto-primario);
            font-size: 1rem;
            font-family: 'Inter', sans-serif;
            transition: border-color 0.2s ease, box-shadow 0.2s ease;
        }
        input:focus, select:focus {
            outline: none;
            border-color: var(--cor-primaria);
            box-shadow: 0 0 0 3px rgba(76, 110, 245, 0.2);
        }
        .form-actions {
            display: flex;
            gap: 1rem;
            margin-top: 1.5rem;
        }

        /* 6. Botões (sem alteração) */
        button { display: inline-flex; align-items: center; gap: 0.5rem; padding: 0.75rem 1.5rem; font-size: 0.95rem; border-radius: 8px; cursor: pointer; border: none; transition: filter 0.2s ease-in-out; font-weight: 600; font-family: 'Inter', sans-serif; }
        button svg { width: 16px; height: 16px; }
        .btn-primary { background-color: var(--cor-primaria); color: #ffffff; }
        .btn-primary:hover { filter: brightness(90%); }
        .btn-secondary { background-color: var(--cor-borda); color: var(--cor-texto-secundario); font-weight: 500; }
        .btn-secondary:hover { background-color: #dce1e6; }
        .btn-danger { background-color: var(--cor-perigo); color: #ffffff; }
        .btn-danger:hover { filter: brightness(90%); }
        .btn-info { background-color: var(--cor-info); color: #ffffff; }
        .btn-info:hover { filter: brightness(90%); }


        /* 7. Tabela */
        table {
            width: 100%;
            border-collapse: collapse;
            color: var(--cor-texto-secundario);
        }
        th, td {
            padding: 1rem;
            text-align: left;
            border-bottom: 1px solid var(--cor-borda);
        }
        thead th {
            font-size: 0.85rem;
            font-weight: 600;
            text-transform: uppercase;
            color: var(--cor-texto-secundario);
            background-color: var(--cor-fundo);
        }
        tbody tr:hover { background-color: #fcfcfd; }
        tbody td { font-size: 0.95rem; color: var(--cor-texto-primario); }
        tbody td button { padding: 0.4rem 0.8rem; font-size: 0.85rem; }
        tbody td button svg { width: 14px; height: 14px; }
        .action-buttons { display: flex; gap: 0.5rem; }

        /* 8. Componentes de Pesquisa (sem alteração) */
        .search-results { background-color: var(--cor-superficie); border: 1px solid var(--cor-borda); border-radius: 8px; max-height: 160px; overflow-y: auto; margin-top: -1rem; box-shadow: var(--sombra-card); }
        .result-item { padding: 0.75rem 1rem; cursor: pointer; font-size: 0.95rem; transition: background-color 0.2s ease; }
        .result-item:hover { background-color: #f1f3f5; }
        .result-item:not(:last-child) { border-bottom: 1px solid var(--cor-borda); }
        .selected-item { color: var(--cor-primaria); font-weight: 500; min-height: 1.5rem; margin: 0.5rem 0 1rem 0; font-size: 0.9rem; }

        /* --- INÍCIO: NOVOS Estilos do Modal --- */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(33, 37, 41, 0.5); /* --cor-texto-primario com 50% de opacidade */
            display: none; /* Escondido por padrão */
            align-items: center;
            justify-content: center;
            z-index: 1000;
            opacity: 0;
            transition: opacity 0.2s ease-in-out;
        }
        .modal-overlay.active {
            display: flex;
            opacity: 1;
        }
        .modal-content {
            /* Reutilizando o estilo do card */
            background-color: var(--cor-superficie);
            border: 1px solid var(--cor-borda);
            border-radius: 12px;
            padding: 2.5rem;
            box-shadow: var(--sombra-card);

            width: 90%;
            max-width: 600px;
            position: relative;
            z-index: 1001;
            /* Animação de "zoom" */
            transform: scale(0.95);
            transition: transform 0.2s ease-in-out;
        }
        .modal-overlay.active .modal-content {
            transform: scale(1);
        }
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            /* Reutilizando o estilo do card-title */
            font-size: 1.5rem;
            margin-bottom: 1.5rem;
            font-weight: 600;
            color: var(--cor-texto-primario);
            border-bottom: 1px solid var(--cor-borda);
            padding-bottom: 1rem;
        }
        .modal-close {
            font-size: 2.5rem;
            font-weight: 300;
            color: var(--cor-texto-secundario);
            cursor: pointer;
            line-height: 1;
            border: none;
            background: transparent;
            padding: 0;
        }
        .modal-close:hover {
            color: var(--cor-texto-primario);
        }
        /* --- FIM: NOVOS Estilos do Modal --- */

        /* 9. Responsividade */
        @media (max-width: 1024px) {
            .main-grid {
                grid-template-columns: 1fr; /* Coluna única em tablets */
            }
        }
        @media (max-width: 768px) {
            body { font-size: 14px; }
            .navbar { padding: 1rem; flex-direction: column; gap: 1rem; }
            .container { margin: 1.5rem auto; padding: 0 1rem; }
            .card { padding: 1.5rem; }
            .modal-content { padding: 1.5rem; } /* Modal em mobile */
        }
    </style>
</head>
<body>

<nav class="navbar">
    <a href="#" class="logo">GustySystem</a>
    <div class="nav-links">
        <a href="/orcamentos">Orçamentos</a>
        <a href="/usuarios" class="active">Usuários</a>
        <a href="/clientes">Clientes</a>
    </div>
</nav>

<div class="container">
    <div class="main-grid">
        <aside class="card">
            <h2 class="card-title">Novo Usuário</h2>
            <form id="usuarioForm">
                <label for="nomeUsuario">Nome do Usuário</label>
                <input type="text" id="nomeUsuario" required placeholder="Nome completo">

                <label for="rg">RG</label>
                <input type="text" id="rg" required placeholder="Digite o RG">

                <label for="cpf">CPF</label>
                <input type="text" id="cpf" required placeholder="Digite o CPF">

                <label for="nomeMae">Nome da Mãe</label>
                <input type="text" id="nomeMae" required placeholder="Nome da mãe">

                <div class="form-actions">
                    <button id="salvarUsuario" type="submit" class="btn-primary">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M19,9H5a1,1,0,0,0-1,1V19a1,1,0,0,0,1,1H19a1,1,0,0,0,1-1V10A1,1,0,0,0,19,9ZM7,17a1,1,0,1,1,1-1A1,1,0,0,1,7,17ZM17,7H7V4H17Z"/></svg>
                        Salvar
                    </button>
                    <button id="btnLimpar" type="button" class="btn-secondary">Limpar</button>
                </div>
            </form>
        </aside>

        <main class="card">
            <h2 class="card-title">Usuários Cadastrados</h2>
            <table>
                <thead>
                <tr>
                    <th>ID</th>
                    <th>Nome</th>
                    <th>RG</th>
                    <th>CPF</th>
                    <th>Ações</th>
                </tr>
                </thead>
                <tbody id="userTableBody"></tbody>
            </table>
        </main>
    </div>
</div>

<div class="modal-overlay" id="editModalOverlay">
    <div class="modal-content">
        <div class="modal-header">
            <h2 class="card-title" style="margin-bottom: 0; border: none; padding: 0;">Editar Usuário</h2>
            <button class="modal-close" id="modalCloseBtn">&times;</button>
        </div>

        <form id="editUsuarioForm" style="margin-top: 1.5rem;">
            <input type="hidden" id="editId">

            <label for="editNomeUsuario">Nome do Usuário</label>
            <input type="text" id="editNomeUsuario" required placeholder="Nome completo">

            <label for="editRg">RG</label>
            <input type="text" id="editRg" required placeholder="Digite o RG">

            <label for="editCpf">CPF</label>
            <input type="text" id="editCpf" required placeholder="Digite o CPF">

            <label for="editNomeMae">Nome da Mãe</label>
            <input type="text" id="editNomeMae" required placeholder="Nome da mãe">

            <div class="form-actions">
                <button id="salvarEditUsuario" type="submit" class="btn-primary">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M19,9H5a1,1,0,0,0-1,1V19a1,1,0,0,0,1,1H19a1,1,0,0,0,1-1V10A1,1,0,0,0,19,9ZM7,17a1,1,0,1,1,1-1A1,1,0,0,1,7,17ZM17,7H7V4H17Z"/></svg>
                    Atualizar
                </button>
                <button id="btnCancelarEdit" type="button" class="btn-secondary">Cancelar</button>
            </div>
        </form>
    </div>
</div>
<script>
    const API_URL = '/api/usuarios';

    const userTableBody = document.getElementById('userTableBody');
    const usuarioForm = document.getElementById('usuarioForm'); // Formulário da sidebar (Criação)
    const btnLimpar = document.getElementById('btnLimpar');

    // NOVO: Elementos do Modal
    const editModalOverlay = document.getElementById('editModalOverlay');
    const editUsuarioForm = document.getElementById('editUsuarioForm'); // Formulário do Modal (Edição)
    const modalCloseBtn = document.getElementById('modalCloseBtn');
    const btnCancelarEdit = document.getElementById('btnCancelarEdit');

    // Variável para guardar todos os usuários (para o autocomplete da sidebar)
    let allUsuarios = [];

    // --- Funções de Máscara (sem alteração) ---
    const formatarCPF = (cpf) => {
        if (!cpf) return '';
        let v = cpf.replace(/\D/g, ''); v = v.substring(0, 11);
        v = v.replace(/(\d{3})(\d)/, '$1.$2'); v = v.replace(/(\d{3})(\d)/, '$1.$2');
        v = v.replace(/(\d{3})(\d{1,2})$/, '$1-$2'); return v;
    };
    const formatarRG = (rg) => {
        if (!rg) return '';
        let v = rg.replace(/\D/g, ''); v = v.substring(0, 9);
        v = v.replace(/(\d{2})(\d)/, '$1.$2'); v = v.replace(/(\d{3})(\d)/, '$1.$2');
        v = v.replace(/(\d{3})(\d{1})$/, '$1-$2'); return v;
    };
    const removerSugestoes = () => {
        const oldSuggestions = document.getElementById('autocomplete-results');
        if (oldSuggestions) oldSuggestions.remove();
    };
    // --- FIM Funções de Máscara ---


    // --- READ (ALL) ---
    const fetchAndRenderTable = async () => {
        try {
            const response = await fetch(API_URL);
            if (!response.ok) throw new Error('Falha ao buscar usuários');

            allUsuarios = await response.json();
            userTableBody.innerHTML = '';

            allUsuarios.forEach(user => {
                // ALTERADO: Adicionado <td> para RG
                const row = `
                    <tr>
                        <td>${user.id}</td>
                        <td>${user.nomeUsuario}</td>
                        <td>${formatarRG(user.rg)}</td>
                        <td>${formatarCPF(user.cpf)}</td>
                        <td>
                            <div class="action-buttons">
                                <button class="btn-info" data-action="edit" data-id="${user.id}">
                                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M20.71,7.04C21.1,6.65 21.1,6 20.71,5.63L18.37,3.29C18,2.9 17.35,2.9 16.96,3.29L15.13,5.12L18.88,8.87M3,17.25V21H6.75L17.81,9.94L14.06,6.19L3,17.25Z"/></svg>
                                    Editar
                                </button>
                                <button class="btn-danger" data-action="delete" data-id="${user.id}">
                                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M9,3V4H4V6H5V19C5,20.1 5.9,21 7,21H17C18.1,21 19,20.1 19,19V6H20V4H15V3H9M7,6H17V19H7V6M9,8V17H11V8H9M13,8V17H15V8H13Z"/></svg>
                                    Excluir
                                </button>
                            </div>
                        </td>
                    </tr>
                `;
                userTableBody.insertAdjacentHTML('beforeend', row);
            });
        } catch (error) {
            console.error('Erro ao carregar a tabela de usuários:', error);
        }
    };

    // --- NOVO: Funções do Modal ---
    const openEditModal = (user) => {
        // Preenche o formulário do *modal* com os dados do usuário
        document.getElementById('editId').value = user.id;
        document.getElementById('editNomeUsuario').value = user.nomeUsuario;
        document.getElementById('editNomeMae').value = user.nomeMae;
        // Aplica as máscaras
        document.getElementById('editRg').value = formatarRG(user.rg);
        document.getElementById('editCpf').value = formatarCPF(user.cpf);

        // Exibe o modal
        editModalOverlay.classList.add('active');
    };

    const closeEditModal = () => {
        editModalOverlay.classList.remove('active');
        editUsuarioForm.reset(); // Limpa o formulário do modal ao fechar
    };

    // --- FIM: Funções do Modal ---


    // Função para limpar o formulário da SIDEBAR
    const clearForm = () => {
        usuarioForm.reset();
        removerSugestoes();
    };

    // --- Event Listener da Tabela (Ações) ---
    userTableBody.addEventListener('click', async (e) => {
        const button = e.target.closest('button[data-id]');
        if (!button) return;

        const userId = button.dataset.id;
        const action = button.dataset.action;

        if (action === 'edit') {
            // --- ALTERADO: Lógica de Edição (READ ONE) ---
            try {
                const response = await fetch(`${API_URL}/${userId}`);
                if (response.ok) {
                    const user = await response.json();
                    // Em vez de popular o form da sidebar, abre o modal
                    openEditModal(user);
                } else {
                    alert('Usuário não encontrado.');
                }
            } catch (error) {
                console.error('Erro ao buscar usuário para edição:', error);
            }

        } else if (action === 'delete') {
            // --- Lógica de Exclusão (DELETE) ---
            if (!confirm(`Tem certeza que deseja excluir o usuário ID ${userId}?`)) {
                return;
            }
            try {
                const response = await fetch(`${API_URL}/${userId}`, {
                    method: 'DELETE',
                });
                if (response.ok) {
                    alert('Usuário excluído com sucesso!');
                    fetchAndRenderTable(); // Atualiza a tabela
                } else {
                    alert('Falha ao excluir usuário.');
                }
            } catch (error) {
                console.error('Erro ao excluir usuário:', error);
                alert('Ocorreu um erro de rede ao tentar excluir o usuário.');
            }
        }
    });

    // --- CREATE (Formulário da Sidebar) ---
    usuarioForm.addEventListener('submit', async (e) => {
        e.preventDefault();

        // Pega dados do form da SIDEBAR
        const userData = {
            nomeUsuario: document.getElementById('nomeUsuario').value,
            rg: document.getElementById('rg').value.replace(/\D/g, ''),
            cpf: document.getElementById('cpf').value.replace(/\D/g, ''),
            nomeMae: document.getElementById('nomeMae').value,
        };

        // NOTA: O 'id' não é mais enviado daqui. Este form é só para CREATE.
        // Se o usuário usou o autocomplete, o 'id' estará no form,
        // mas o backend (assumindo a lógica anterior) tratará como 'save' (Update).
        // Para forçar este form a ser APENAS CREATE, removemos o campo 'id' dele.
        // (Eu já removi o <input hidden id="id"> do HTML do form da sidebar).

        try {
            const response = await fetch(API_URL, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(userData),
            });

            if (!response.ok) {
                throw new Error('Falha ao salvar. Status: ' + response.status);
            }

            clearForm();
            fetchAndRenderTable();
            alert('Usuário CADASTRADO com sucesso!'); // Mensagem específica de criação

        } catch (error) {
            console.error('Erro ao salvar usuário:', error);
            alert('Ocorreu um erro ao salvar o usuário.');
        }
    });

    // --- NOVO: UPDATE (Formulário do Modal) ---
    editUsuarioForm.addEventListener('submit', async (e) => {
        e.preventDefault();

        // Pega dados do form do MODAL
        const userData = {
            id: document.getElementById('editId').value, // ID é obrigatório aqui
            nomeUsuario: document.getElementById('editNomeUsuario').value,
            rg: document.getElementById('editRg').value.replace(/\D/g, ''),
            cpf: document.getElementById('editCpf').value.replace(/\D/g, ''),
            nomeMae: document.getElementById('editNomeMae').value,
        };

        try {
            const response = await fetch(API_URL, {
                method: 'POST', // ou 'PUT', dependendo da sua API. Usando 'POST' para manter consistência
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(userData),
            });

            if (!response.ok) {
                throw new Error('Falha ao atualizar. Status: ' + response.status);
            }

            closeEditModal(); // Fecha o modal
            fetchAndRenderTable(); // Atualiza a tabela
            alert('Usuário ATUALIZADO com sucesso!'); // Mensagem específica de atualização

        } catch (error) {
            console.error('Erro ao atualizar usuário:', error);
            alert('Ocorreu um erro ao atualizar o usuário.');
        }
    });


    // --- Outros Event Listeners ---

    // Limpar form da sidebar
    btnLimpar.addEventListener('click', clearForm);

    // Fechar modal (botões 'X' e 'Cancelar')
    modalCloseBtn.addEventListener('click', closeEditModal);
    btnCancelarEdit.addEventListener('click', closeEditModal);

    // Fechar modal (clique fora)
    editModalOverlay.addEventListener('click', (e) => {
        if (e.target === editModalOverlay) {
            closeEditModal();
        }
    });


    // Adiciona os listeners de input quando o DOM estiver pronto
    document.addEventListener('DOMContentLoaded', () => {
        fetchAndRenderTable(); // Carrega os dados iniciais (READ ALL)

        // --- Máscaras do Form da SIDEBAR ---
        document.getElementById('cpf').addEventListener('input', (e) => {
            e.target.value = formatarCPF(e.target.value);
        });
        document.getElementById('rg').addEventListener('input', (e) => {
            e.target.value = formatarRG(e.target.value);
        });

        // --- NOVO: Máscaras do Form do MODAL ---
        document.getElementById('editCpf').addEventListener('input', (e) => {
            e.target.value = formatarCPF(e.target.value);
        });
        document.getElementById('editRg').addEventListener('input', (e) => {
            e.target.value = formatarRG(e.target.value);
        });


        // --- Autocomplete (Ainda funciona na sidebar, mas não é o fluxo principal) ---
        // (Esta função foi mantida, mas como o 'id' foi removido do form
        // da sidebar, ela não populará mais o ID, forçando o form
        // a ser sempre 'Create'. Se quiser que o autocomplete *também*
        // edite, o <input hidden id="id"> deve ser mantido no form da sidebar
        // e a lógica do 'submit' da sidebar precisa checar o ID.)

        // **Vou manter a lógica original do autocomplete que *permite* editar
        // pela sidebar, mas o botão 'Editar' *abre* o modal.
        // Para isso, preciso readicionar o <input type="hidden" id="id">
        // e reverter a lógica do 'usuarioForm.submit'.**

        // ***** REFAZENDO A LÓGICA (MELHOR) *****
        // 1. Ocultar o <input id="id"> no form da sidebar (como estava antes).
        // 2. A lógica do `usuarioForm.submit` volta a checar o ID (como estava antes).
        // 3. O autocomplete volta a popular o ID (com a função `populateForm` que vou recriar).
        // 4. A única mudança real será no `userTableBody.click`, que agora chama `openEditModal` em vez de `populateForm`.

        // (O código abaixo já reflete esta lógica final e correta)

    });
</script>

</body>
</html>